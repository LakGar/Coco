// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CAREGIVER
  FAMILY
  PHYSICIAN
  PATIENT
}

enum TeamRole {
  CAREGIVER
  FAMILY
  PHYSICIAN
  PATIENT
}

enum AccessLevel {
  FULL
  READ_ONLY
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  TODO
  DONE
  CANCELLED
  DUE
}

enum RecurrenceType {
  DAILY
  WEEKLY
  MONTHLY
  CUSTOM_WEEKDAYS
  SPECIFIC_DATES
}

model User {
  id        String   @id @default(cuid())
  clerkId   String?  @unique
  email     String   @unique
  firstName String?
  lastName  String?
  name      String?  // Computed or fallback
  imageUrl  String?
  role      UserRole
  city      String?
  state     String?
  onboardingComplete Boolean @default(false)

  // teams the user is a member of
  teamMemberships CareTeamMember[]

  // teams where this user is the patient
  patientTeams CareTeam[] @relation("PatientTeams")

  // tasks created by this user
  createdTasks Task[] @relation("CreatedTasks")
  
  // tasks assigned to this user (optional for now)
  assignedTasks Task[] @relation("AssignedTasks")

  // routines created by this user
  createdRoutines Routine[] @relation("CreatedRoutines")
  
  // routines assigned to this user
  assignedRoutines Routine[] @relation("AssignedRoutines")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CareTeam {
  id        String   @id @default(cuid())
  name      String

  // 1 care team = 1 patient workspace
  // patientId is optional - patient User is created when they accept invite
  patientId String?
  patient   User?    @relation("PatientTeams", fields: [patientId], references: [id])

  members   CareTeamMember[]
  tasks     Task[]
  routines  Routine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([patientId])
}

model CareTeamMember {
  id          String   @id @default(cuid())
  teamId      String
  userId      String?

  // what they are in THIS team (context)
  teamRole    TeamRole

  // access control (what you asked for)
  isAdmin     Boolean     @default(false)
  accessLevel AccessLevel @default(FULL)

  // Invite system
  inviteCode  String?  @unique
  inviteEmail String?
  invitedName String?  // Name of the invited member (before they sign up)
  invitedAt   DateTime?
  acceptedAt  DateTime?

  team        CareTeam @relation(fields: [teamId], references: [id])
  user        User?    @relation(fields: [userId], references: [id])

  joinedAt    DateTime @default(now())

  // prevents duplicate membership (only when user exists)
  // Note: Using partial unique index for userId to allow multiple nulls
  @@unique([teamId, userId], name: "team_user_unique")
  @@index([userId])
  @@index([teamId])
  @@index([inviteCode])
}

model Task {
  id          String      @id @default(cuid())
  name        String
  description String?
  
  teamId      String
  team        CareTeam    @relation(fields: [teamId], references: [id])
  
  patientName String?     // Patient name for this task
  
  createdById String
  createdBy   User        @relation("CreatedTasks", fields: [createdById], references: [id])
  
  assignedToId String?    // Optional assignment (for future use)
  assignedTo   User?       @relation("AssignedTasks", fields: [assignedToId], references: [id])
  
  priority    TaskPriority @default(MEDIUM)
  status      TaskStatus   @default(TODO)
  
  dueDate     DateTime?   // Optional due date and time
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Link to routine if this task was generated from a routine
  routineId      String?
  routine        Routine? @relation("RoutineTasks", fields: [routineId], references: [id])
  routineInstanceId String?
  routineInstance RoutineInstance? @relation("RoutineInstanceTasks", fields: [routineInstanceId], references: [id])

  @@index([teamId])
  @@index([createdById])
  @@index([assignedToId])
  @@index([status])
  @@index([priority])
  @@index([routineId])
  @@index([routineInstanceId])
}

model Routine {
  id          String   @id @default(cuid())
  name        String
  description String?
  
  teamId      String
  team        CareTeam @relation(fields: [teamId], references: [id])
  
  patientName String?  // Patient name for this routine
  
  createdById String
  createdBy   User     @relation("CreatedRoutines", fields: [createdById], references: [id])
  
  assignedToId String? // Optional assignment
  assignedTo   User?    @relation("AssignedRoutines", fields: [assignedToId], references: [id])
  
  priority    TaskPriority @default(MEDIUM)
  
  // Recurrence configuration
  recurrenceType RecurrenceType
  recurrenceDaysOfWeek Int[] // 0=Sunday, 1=Monday, etc. (for WEEKLY and CUSTOM_WEEKDAYS)
  recurrenceDayOfMonth Int?  // For MONTHLY (1-31)
  recurrenceSpecificDates DateTime[] // For SPECIFIC_DATES
  
  // Time settings
  startDate   DateTime
  endDate     DateTime? // null = repeat indefinitely
  timeOfDay   String?   // HH:mm format for daily time
  
  // Task generation settings
  autoGenerateTasks Boolean @default(true) // Whether to auto-create tasks
  generateDaysAhead Int @default(7) // How many days ahead to generate tasks
  
  // Journal/Data tracking
  hasJournalEntry Boolean @default(false) // Whether this routine collects journal data
  journalPrompts  String[] // Optional prompts/questions for journal entries
  
  // Status
  isActive    Boolean @default(true)
  
  // Generated instances and tasks
  instances  RoutineInstance[]
  tasks      Task[] @relation("RoutineTasks")
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@index([teamId])
  @@index([createdById])
  @@index([assignedToId])
  @@index([isActive])
  @@index([startDate])
}

model RoutineInstance {
  id          String   @id @default(cuid())
  routineId   String
  routine     Routine  @relation(fields: [routineId], references: [id])
  
  // Scheduled date for this instance
  scheduledDate DateTime
  
  // Completion tracking
  completedAt DateTime?
  isCompleted Boolean @default(false)
  isSkipped   Boolean @default(false)
  skippedAt   DateTime?
  
  // Journal entry data (JSON for flexibility)
  journalData Json? // Stores structured journal entry data
  
  // Link to generated tasks (if auto-generated) - one-to-many since we might generate multiple tasks
  tasks       Task[] @relation("RoutineInstanceTasks")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([routineId, scheduledDate]) // One instance per routine per date
  @@index([routineId])
  @@index([scheduledDate])
  @@index([isCompleted])
}
