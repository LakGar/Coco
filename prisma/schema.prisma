// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CAREGIVER
  FAMILY
  PHYSICIAN
  PATIENT
}

enum TeamRole {
  CAREGIVER
  FAMILY
  PHYSICIAN
  PATIENT
}

enum AccessLevel {
  FULL
  READ_ONLY
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  TODO
  DONE
  CANCELLED
  DUE
}

enum TaskType {
  MEDICATION
  APPOINTMENTS
  SOCIAL
  HEALTH_PERSONAL
}

enum MoodRating {
  // Positive / Neutral
  CALM
  CONTENT
  NEUTRAL
  RELAXED
  // Low / Withdrawn
  SAD
  WITHDRAWN
  TIRED
  // Agitated / Challenging
  ANXIOUS
  IRRITABLE
  RESTLESS
  CONFUSED
}

enum RecurrenceType {
  DAILY
  WEEKLY
  MONTHLY
  CUSTOM_WEEKDAYS
  SPECIFIC_DATES
}

enum NotificationType {
  CONTACT_SETUP_REMINDER
  TASK_DUE
  ROUTINE_MISSED
  TEAM_INVITE
  PERMISSION_CHANGE
  SYSTEM_ALERT
}

enum NotificationFrequency {
  EVERY_EVENT
  DAILY
  WEEKLY
  DISABLED
}

model User {
  id                 String   @id @default(cuid())
  clerkId            String?  @unique
  email              String   @unique
  firstName          String?
  lastName           String?
  name               String? // Computed or fallback
  imageUrl           String?
  role               UserRole
  city               String?
  state              String?
  onboardingComplete Boolean  @default(false)

  // teams the user is a member of
  teamMemberships CareTeamMember[]

  // teams where this user is the patient
  patientTeams CareTeam[] @relation("PatientTeams")

  // tasks created by this user
  createdTasks Task[] @relation("CreatedTasks")

  // tasks assigned to this user (optional for now)
  assignedTasks Task[] @relation("AssignedTasks")

  // routines created by this user
  createdRoutines Routine[] @relation("CreatedRoutines")

  // moods logged by this user
  loggedMoods Mood[] @relation("LoggedMoods")

  // notes created by this user
  createdNotes Note[] @relation("CreatedNotes")

  // notes this user can edit
  editableNotes NoteEditor[] @relation("NoteEditors")

  // notes this user can view
  viewableNotes NoteViewer[] @relation("NoteViewers")

  // notes last edited by this user
  lastEditedNotes Note[] @relation("LastEditedNotes")

  // contacts created by this user
  createdContacts Contact[] @relation("CreatedContacts")

  // notifications for this user
  notifications Notification[] @relation("Notifications")

  // caregiver burden scales completed by this user
  caregiverBurdenScales CaregiverBurdenScale[] @relation("CaregiverBurdenScales")

  // notification preferences
  notificationSettings UserNotificationSettings?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CareTeam {
  id   String @id @default(cuid())
  name String

  // 1 care team = 1 patient workspace
  // patientId is optional - patient User is created when they accept invite
  patientId String?
  patient   User?   @relation("PatientTeams", fields: [patientId], references: [id])

  members               CareTeamMember[]
  tasks                 Task[]
  routines              Routine[]
  moods                 Mood[]
  notes                 Note[]
  contacts              Contact[]
  notifications         Notification[]
  caregiverBurdenScales CaregiverBurdenScale[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([patientId])
}

model CareTeamMember {
  id     String  @id @default(cuid())
  teamId String
  userId String?

  // what they are in THIS team (context)
  teamRole TeamRole

  // access control (what you asked for)
  isAdmin     Boolean     @default(false)
  accessLevel AccessLevel @default(FULL)

  // Granular permissions - admins have all permissions automatically
  // Tasks permissions
  canViewTasks   Boolean @default(true)
  canCreateTasks Boolean @default(true)
  canEditTasks   Boolean @default(true)
  canDeleteTasks Boolean @default(true)

  // Notes permissions
  canViewNotes   Boolean @default(true)
  canCreateNotes Boolean @default(true)
  canEditNotes   Boolean @default(true)
  canDeleteNotes Boolean @default(true)

  // Routines permissions
  canViewRoutines   Boolean @default(true)
  canCreateRoutines Boolean @default(true)
  canEditRoutines   Boolean @default(true)
  canDeleteRoutines Boolean @default(true)

  // Contacts permissions
  canViewContacts   Boolean @default(true)
  canCreateContacts Boolean @default(true)
  canEditContacts   Boolean @default(true)
  canDeleteContacts Boolean @default(true)

  // Moods permissions
  canViewMoods   Boolean @default(true)
  canCreateMoods Boolean @default(true)

  // Caregiver Burden permissions
  canViewBurdenScales   Boolean @default(true)
  canCreateBurdenScales Boolean @default(true)

  // Team management permissions
  canViewMembers       Boolean @default(true)
  canInviteMembers     Boolean @default(false) // Only admins by default
  canRemoveMembers     Boolean @default(false) // Only admins by default
  canManagePermissions Boolean @default(false) // Only admins by default

  // Invite system
  inviteCode  String?   @unique
  inviteEmail String?
  invitedName String? // Name of the invited member (before they sign up)
  invitedAt   DateTime?
  acceptedAt  DateTime?

  team CareTeam @relation(fields: [teamId], references: [id])
  user User?    @relation(fields: [userId], references: [id])

  joinedAt DateTime @default(now())

  // prevents duplicate membership (only when user exists)
  // Note: Using partial unique index for userId to allow multiple nulls
  @@unique([teamId, userId], name: "team_user_unique")
  @@index([userId])
  @@index([teamId])
  @@index([inviteCode])
}

model Task {
  id          String  @id @default(cuid())
  name        String
  description String?

  teamId String
  team   CareTeam @relation(fields: [teamId], references: [id])

  patientName String? // Patient name for this task

  createdById String
  createdBy   User   @relation("CreatedTasks", fields: [createdById], references: [id])

  assignedToId String? // Optional assignment (for future use)
  assignedTo   User?   @relation("AssignedTasks", fields: [assignedToId], references: [id])

  priority TaskPriority @default(MEDIUM)
  status   TaskStatus   @default(TODO)
  type     TaskType? // Optional task type (MEDICATION, APPOINTMENTS, SOCIAL, HEALTH_PERSONAL)

  // Personal tasks are only visible to the creator
  isPersonal Boolean @default(false)

  dueDate DateTime? // Optional due date and time

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Note: Tasks are now separate from routines - routines are journal checklists only

  @@index([teamId])
  @@index([createdById])
  @@index([assignedToId])
  @@index([status])
  @@index([priority])
  @@index([type])
  @@index([isPersonal])
}

model Routine {
  id          String  @id @default(cuid())
  name        String
  description String?

  teamId String
  team   CareTeam @relation(fields: [teamId], references: [id])

  patientName String? // Patient name for this routine

  createdById String
  createdBy   User   @relation("CreatedRoutines", fields: [createdById], references: [id])

  // Checklist items (Yes/No questions) - e.g., ["Did you take your medication?", "Did you exercise?"]
  checklistItems String[] // Array of questions/prompts

  // Recurrence - simplified to just days of week
  recurrenceDaysOfWeek Int[] // [0,1,2,3,4,5,6] for daily, [1,3,5] for MWF, etc. (0=Sunday)

  // Time settings
  startDate DateTime
  endDate   DateTime? // null = repeat indefinitely (can set for a month)

  // Status
  isActive Boolean @default(true)

  // Journal instances
  instances RoutineInstance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([createdById])
  @@index([isActive])
  @@index([startDate])
}

model RoutineInstance {
  id        String  @id @default(cuid())
  routineId String
  routine   Routine @relation(fields: [routineId], references: [id])

  // Date this journal entry is for
  entryDate DateTime // The day this journal entry is about

  // Yes/No answers - stored as JSON: { "Did you take medication?": true, "Did you exercise?": false }
  answers Json? // Map of question -> boolean (Yes/No)

  // Optional notes/observations
  notes String?

  // When was this filled out
  filledOutAt DateTime @default(now())
  filledOutBy String? // userId who filled it out

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([routineId, entryDate]) // One entry per routine per day
  @@index([routineId])
  @@index([entryDate])
  @@index([filledOutAt])
}

model Mood {
  id     String   @id @default(cuid())
  teamId String
  team   CareTeam @relation(fields: [teamId], references: [id])

  // Who logged this mood entry
  loggedById String
  loggedBy   User   @relation("LoggedMoods", fields: [loggedById], references: [id])

  // Mood rating (1-5 scale)
  rating MoodRating

  // Optional notes/context
  notes String?

  // When this mood was observed/logged
  observedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([loggedById])
  @@index([observedAt])
  @@index([rating])
}

model Note {
  id     String   @id @default(cuid())
  teamId String
  team   CareTeam @relation(fields: [teamId], references: [id])

  // Note content
  title   String
  content String

  // Who created this note
  createdById String
  createdBy   User   @relation("CreatedNotes", fields: [createdById], references: [id])

  // Last person who edited
  lastEditedById String?
  lastEditedBy   User?   @relation("LastEditedNotes", fields: [lastEditedById], references: [id])

  // Permissions - editors and viewers
  editors NoteEditor[] @relation("NoteEditors")
  viewers NoteViewer[] @relation("NoteViewers")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([createdById])
  @@index([updatedAt])
}

model NoteEditor {
  id     String @id @default(cuid())
  noteId String
  note   Note   @relation("NoteEditors", fields: [noteId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("NoteEditors", fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([noteId, userId])
  @@index([noteId])
  @@index([userId])
}

model NoteViewer {
  id     String @id @default(cuid())
  noteId String
  note   Note   @relation("NoteViewers", fields: [noteId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("NoteViewers", fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([noteId, userId])
  @@index([noteId])
  @@index([userId])
}

enum ContactType {
  EMERGENCY_CONTACT
  EMERGENCY_SERVICES
  SUPPORT_GROUP
  PHYSICIAN
  PHARMACY
  INSURANCE
  OTHER
}

model Contact {
  id     String   @id @default(cuid())
  teamId String
  team   CareTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)

  type      ContactType
  name      String
  phone     String?
  email     String?
  address   String?
  notes     String?
  isPrimary Boolean     @default(false) // For emergency contacts, mark primary

  createdById String
  createdBy   User   @relation("CreatedContacts", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([type])
  @@index([createdById])
}

model Notification {
  id     String   @id @default(cuid())
  teamId String
  team   CareTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)

  userId String // User who should see this notification
  user   User   @relation("Notifications", fields: [userId], references: [id], onDelete: Cascade)

  type    NotificationType
  title   String
  message String
  isRead  Boolean          @default(false)
  readAt  DateTime?

  // Optional link to related resource
  linkUrl   String?
  linkLabel String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

// Caregiver Burden Scale - Zarit Burden Interview (ZBI) questionnaire
model CaregiverBurdenScale {
  id     String   @id @default(cuid())
  teamId String
  team   CareTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)

  userId String // Caregiver/family member who completed the questionnaire
  user   User   @relation("CaregiverBurdenScales", fields: [userId], references: [id], onDelete: Cascade)

  // ZBI has 22 questions, each scored 0-4 (Never, Rarely, Sometimes, Quite Frequently, Nearly Always)
  // Store as JSON: { "question1": 0, "question2": 3, ... }
  responses Json // Map of question number -> score (0-4)

  // Total score (sum of all responses, 0-88)
  totalScore Int

  // Interpretation: 0-20 (Little or no burden), 21-40 (Mild to moderate burden), 41-60 (Moderate to severe burden), 61-88 (Severe burden)
  burdenLevel String // "LOW" | "MILD_MODERATE" | "MODERATE_SEVERE" | "SEVERE"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([userId])
  @@index([createdAt])
}

// User Notification Settings - allows users to configure notification preferences
model UserNotificationSettings {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notification frequency preferences for each type
  contactSetupReminderFrequency NotificationFrequency @default(EVERY_EVENT)
  taskDueFrequency              NotificationFrequency @default(EVERY_EVENT)
  routineMissedFrequency        NotificationFrequency @default(EVERY_EVENT)
  teamInviteFrequency           NotificationFrequency @default(EVERY_EVENT)
  permissionChangeFrequency     NotificationFrequency @default(EVERY_EVENT)
  systemAlertFrequency          NotificationFrequency @default(EVERY_EVENT)

  // Email notification preferences
  emailNotificationsEnabled Boolean @default(true)

  // Push notification preferences (for future use)
  pushNotificationsEnabled Boolean @default(true)

  // Daily digest time (for DAILY frequency) - stored as HH:MM in UTC
  dailyDigestTime String? @default("09:00") // 9 AM UTC default

  // Weekly digest day and time (for WEEKLY frequency)
  weeklyDigestDay  Int?    @default(1) // Monday = 1, Sunday = 0
  weeklyDigestTime String? @default("09:00") // 9 AM UTC default

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}
